<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>학업 알리미 - 내 프로필</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#4f46e5" />
    <meta
      name="description"
      content="학교 수행평가 일정을 관리하고 알림을 받을 수 있는 서비스"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="학업 알리미" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/android-chrome-192x192" />
    <meta name="mobile-web-app-capable" content="yes" />
    <!-- Pretendard 폰트 -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css"
    />
    <!-- Font Awesome 아이콘 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Pretendard";
      }
      /* 모바일 하단 네비게이션 바를 위한 여백 */
      .mobile-nav-padding {
        padding-bottom: 4rem;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#10B981",
              accent: "#F59E0B",
              danger: "#EF4444",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen mobile-nav-padding">
    <!-- 헤더 - 데스크톱에서만 표시 -->
    <header class="hidden md:block">
      <div
        class="container mx-auto px-4 py-4 flex justify-between items-center"
      >
        <h1 class="text-2xl font-bold text-primary">학업 알리미</h1>
        <nav>
          <ul class="flex space-x-4">
            <li>
              <a href="index.html" class="text-gray-600 hover:text-primary"
                >홈</a
              >
            </li>
            <li>
              <a href="alerts.html" class="text-gray-600 hover:text-primary"
                >알리미</a
              >
            </li>
            <li>
              <a href="profile.html" class="text-primary font-medium"
                >내 정보</a
              >
            </li>
            <li>
              <a href="login.html" class="text-gray-600 hover:text-primary"
                >로그인</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- 모바일 헤더 - 모바일에서만 표시 -->
    <header class="md:hidden">
      <div class="container mx-auto px-4 py-4 flex justify-center items-center">
        <h1 class="text-xl font-bold text-primary">내 정보</h1>
      </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container mx-auto px-4 py-8">
      <!-- 프로필 정보 섹션 -->
      <section class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-col md:flex-row items-center md:items-start">
          <div class="flex-1 text-center md:text-left">
            <h2 id="user-name" class="text-2xl font-bold mb-2">사용자</h2>
            <p id="user-school-info" class="text-gray-600 mb-4">학교 정보</p>
          </div>
        </div>
      </section>

      <!-- 설정 섹션 -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <div class="p-6">
          <h3 class="text-lg font-semibold mb-4">학교 정보</h3>

          <!-- 학교 정보 수정 폼 -->
          <form id="school-form" class="mb-6">
            <div class="mb-4">
              <label
                for="school"
                class="block text-sm font-medium text-gray-700 mb-1"
                >학교</label
              >
              <select
                id="school"
                name="school"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
              >
                <option value="">학교를 선택하세요</option>
              </select>
            </div>
            <div class="mb-4">
              <label
                for="grade"
                class="block text-sm font-medium text-gray-700 mb-1"
                >학년</label
              >
              <select
                id="grade"
                name="grade"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
              >
                <option value="">학년을 선택하세요</option>
                <option value="grade1">1학년</option>
                <option value="grade2">2학년</option>
                <option value="grade3">3학년</option>
                <option value="grade4">4학년</option>
                <option value="grade5">5학년</option>
                <option value="grade6">6학년</option>
              </select>
            </div>
            <div class="mb-4">
              <label
                for="class"
                class="block text-sm font-medium text-gray-700 mb-1"
                >반</label
              >
              <select
                id="class"
                name="class"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
              >
                <option value="">반을 선택하세요</option>
                <option value="class1">1반</option>
                <option value="class2">2반</option>
                <option value="class3">3반</option>
                <option value="class4">4반</option>
                <option value="class5">5반</option>
                <option value="class6">6반</option>
                <option value="class7">7반</option>
                <option value="class8">8반</option>
                <option value="class9">9반</option>
                <option value="class10">10반</option>
              </select>
            </div>
            <button
              type="submit"
              class="bg-primary text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition"
            >
              저장
            </button>
          </form>

          <h3 class="text-lg font-semibold mb-4">계정 설정</h3>

          <!-- 알림 설정 -->
          <div class="mb-6">
            <h4 class="text-md font-semibold mb-3">알림 설정</h4>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-medium">푸시 알림</p>
                  <p class="text-sm text-gray-600">
                    수행평가 마감 하루 전과 매일 <br />아침에 푸시 알림을
                    받습니다.
                  </p>
                </div>
                <div class="flex items-center">
                  <button
                    id="push-subscribe-button"
                    class="bg-primary text-white px-3 py-1 text-sm rounded-md hover:bg-indigo-600 transition mr-2"
                  >
                    구독하기
                  </button>
                  <button
                    id="push-unsubscribe-button"
                    class="bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-md hover:bg-gray-300 transition mr-2 hidden"
                  >
                    구독 취소
                  </button>
                </div>
              </div>
              <div id="push-status" class="text-sm text-gray-600 mt-1"></div>
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-medium">주간 요약</p>
                  <p class="text-sm text-gray-600">
                    매주 월요일에 다음 주 수행평가 요약을 받습니다.
                  </p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="weekly-summary-checkbox"
                    value=""
                    class="sr-only peer"
                  />
                  <div
                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"
                  ></div>
                </label>
              </div>
              <div
                id="weekly-summary-status"
                class="text-sm text-gray-600 mt-1 hidden"
              ></div>
            </div>
          </div>

          <!-- 계정 정보 -->
          <div class="mb-6">
            <h4 class="text-md font-semibold mb-3">계정 정보</h4>
            <form id="account-form">
              <div class="mb-4">
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >이메일</label
                >
                <input
                  type="email"
                  id="email"
                  class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                />
              </div>
              <div class="mb-4">
                <label
                  for="password"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >비밀번호 변경</label
                >
                <input
                  type="password"
                  id="password"
                  placeholder="새 비밀번호"
                  class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary mb-2"
                  minlength="6"
                />
                <input
                  type="password"
                  id="password-confirm"
                  placeholder="비밀번호 확인"
                  class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary mb-2"
                  minlength="6"
                />
                <p class="text-xs text-gray-500">
                  비밀번호는 최소 6자 이상이어야 합니다.
                </p>
                <div id="password-feedback" class="text-sm mt-1 hidden"></div>
              </div>
              <button
                type="submit"
                class="bg-primary text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition"
              >
                저장
              </button>
            </form>
          </div>

          <!-- 데이터 관리 -->
          <div>
            <h4 class="text-md font-semibold mb-3">데이터 관리</h4>
            <div class="space-y-3">
              <button
                id="delete-account-btn"
                class="text-white bg-danger hover:bg-red-600 px-4 py-2 rounded-md transition flex items-center"
              >
                <i class="fas fa-trash-alt mr-2"></i> 계정 삭제
              </button>
              <p class="text-sm text-gray-600 mt-2">
                계정을 삭제하면 모든 데이터가 영구적으로 제거되며 이 작업은
                되돌릴 수 없습니다.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 푸터 -->
    <footer class="py-4 text-black hidden md:block">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-4 md:mb-0">
            <h2 class="text-xl font-bold">학업 알리미</h2>
            <p class="text-sm mt-1">학교 생활을 더 편리하게</p>
          </div>
          <div>
            <p class="text-sm">&copy; 2025 학업 알리미. All rights reserved.</p>
          </div>
        </div>
      </div>
    </footer>

    <!-- 모바일 하단 네비게이션 바 -->
    <nav
      class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200"
    >
      <div class="flex justify-around">
        <a
          href="index.html"
          class="flex flex-col items-center py-2 px-3 text-gray-600"
        >
          <i class="fas fa-home text-xl mb-1"></i>
          <span class="text-xs">홈</span>
        </a>
        <a
          href="alerts.html"
          class="flex flex-col items-center py-2 px-3 text-gray-600"
        >
          <i class="fas fa-clipboard-list text-xl mb-1"></i>
          <span class="text-xs">알리미</span>
        </a>
        <a
          href="profile.html"
          class="flex flex-col items-center py-2 px-3 text-primary"
        >
          <i class="fas fa-user text-xl mb-1"></i>
          <span class="text-xs">내 정보</span>
        </a>
        <a
          href="login.html"
          class="flex flex-col items-center py-2 px-3 text-gray-600"
        >
          <i class="fas fa-sign-in-alt text-xl mb-1"></i>
          <span class="text-xs">로그인</span>
        </a>
      </div>
    </nav>

    <!-- 자바스크립트 -->
    <script>
      // API 기본 URL
      const API_BASE_URL =
        "https://port-0-alert-backend-m5l6sc488b056240.sel4.cloudtype.app/api";

      // 전역 변수
      let isLoggedIn = false;
      let currentUser = null;
      let pushSubscription = null;

      document.addEventListener("DOMContentLoaded", function () {
        // 로그인 상태 확인
        checkLoginStatus();

        // 학교 목록 가져오기
        fetchSchools();

        // 주간 요약 체크박스 이벤트 리스너 추가
        const weeklySummaryCheckbox = document.getElementById(
          "weekly-summary-checkbox"
        );
        const weeklySummaryStatus = document.getElementById(
          "weekly-summary-status"
        );

        if (weeklySummaryCheckbox) {
          // 저장된 설정 불러오기
          const savedWeeklySummary =
            localStorage.getItem("weeklySummary") === "true";
          weeklySummaryCheckbox.checked = savedWeeklySummary;

          weeklySummaryCheckbox.addEventListener("change", function () {
            const isChecked = this.checked;
            updateWeeklySummaryPreference(isChecked)
              .then(() => {
                localStorage.setItem("weeklySummary", isChecked);
                weeklySummaryStatus.textContent = isChecked
                  ? "주간 요약 알림이 활성화되었습니다."
                  : "주간 요약 알림이 비활성화되었습니다.";
                weeklySummaryStatus.className = isChecked
                  ? "text-sm text-green-600 mt-1"
                  : "text-sm text-gray-600 mt-1";
                weeklySummaryStatus.classList.remove("hidden");

                // 3초 후 상태 메시지 숨기기
                setTimeout(() => {
                  weeklySummaryStatus.classList.add("hidden");
                }, 3000);
              })
              .catch((error) => {
                console.error("주간 요약 설정 업데이트 오류:", error);
                weeklySummaryStatus.textContent = `오류: ${
                  error.message || "설정 저장 중 오류가 발생했습니다."
                }`;
                weeklySummaryStatus.className = "text-sm text-red-600 mt-1";
                weeklySummaryStatus.classList.remove("hidden");
                // 체크박스 상태 되돌리기
                this.checked = !isChecked;
              });
          });
        }

        // 학교 정보 폼 제출 처리
        const schoolForm = document.getElementById("school-form");
        if (schoolForm) {
          schoolForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const school = document.getElementById("school").value;
            const grade = document.getElementById("grade").value;
            const className = document.getElementById("class").value;

            if (!school || !grade || !className) {
              alert("모든 필드를 선택해주세요.");
              return;
            }

            updateSchoolInfo(school, grade, className)
              .then(() => {
                alert("학교 정보가 성공적으로 업데이트되었습니다.");
                updateAccountUI();
              })
              .catch((error) => {
                console.error("학교 정보 업데이트 오류:", error);
                alert(
                  `오류: ${
                    error.message ||
                    "학교 정보 업데이트 중 오류가 발생했습니다."
                  }`
                );
              });
          });
        }

        // 계정 정보 폼 제출 처리
        const accountForm = document.getElementById("account-form");
        if (accountForm) {
          accountForm.addEventListener("submit", function (e) {
            e.preventDefault();

            // 폼 데이터 수집
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const passwordConfirm =
              document.getElementById("password-confirm").value;
            const passwordFeedback =
              document.getElementById("password-feedback");

            // 비밀번호 유효성 검사
            if (password) {
              if (password.length < 6) {
                passwordFeedback.textContent =
                  "비밀번호는 최소 6자 이상이어야 합니다.";
                passwordFeedback.className = "text-sm mt-1 text-danger";
                passwordFeedback.classList.remove("hidden");
                return;
              }

              if (password !== passwordConfirm) {
                passwordFeedback.textContent = "비밀번호가 일치하지 않습니다.";
                passwordFeedback.className = "text-sm mt-1 text-danger";
                passwordFeedback.classList.remove("hidden");
                return;
              }
            }

            // 비밀번호 피드백 초기화
            passwordFeedback.classList.add("hidden");

            // 계정 정보 업데이트
            updateAccountInfo(email, password)
              .then(() => {
                // 성공 메시지 표시
                passwordFeedback.textContent =
                  "계정 정보가 성공적으로 업데이트되었습니다.";
                passwordFeedback.className = "text-sm mt-1 text-green-600";
                passwordFeedback.classList.remove("hidden");

                // 비밀번호 필드 초기화
                document.getElementById("password").value = "";
                document.getElementById("password-confirm").value = "";

                // 3초 후 메시지 숨기기
                setTimeout(() => {
                  passwordFeedback.classList.add("hidden");
                }, 3000);
              })
              .catch((error) => {
                console.error("계정 정보 업데이트 오류:", error);
                passwordFeedback.textContent = `오류: ${
                  error.message || "계정 정보 업데이트 중 오류가 발생했습니다."
                }`;
                passwordFeedback.className = "text-sm mt-1 text-danger";
                passwordFeedback.classList.remove("hidden");
              });
          });
        }

        // 계정 삭제 버튼 이벤트 리스너 추가
        const deleteAccountBtn = document.getElementById("delete-account-btn");
        if (deleteAccountBtn) {
          deleteAccountBtn.addEventListener("click", function (e) {
            e.preventDefault();
            deleteAccount();
          });
        }

        // 푸시 알림 구독 버튼 이벤트 리스너 추가
        setupPushNotificationButtons();

        // 푸시 알림 구독 상태 확인
        checkPushSubscription();
      });

      // 푸시 알림 구독 버튼 설정
      function setupPushNotificationButtons() {
        const subscribeButton = document.getElementById(
          "push-subscribe-button"
        );
        const unsubscribeButton = document.getElementById(
          "push-unsubscribe-button"
        );
        const pushStatus = document.getElementById("push-status");

        if (subscribeButton) {
          subscribeButton.addEventListener("click", async function () {
            try {
              await subscribeToPushNotifications();
              updatePushButtons(true);
              pushStatus.textContent = "알림 구독이 완료되었습니다.";
              pushStatus.className = "text-sm text-green-600 mt-1";
            } catch (error) {
              console.error("푸시 알림 구독 오류:", error);
              pushStatus.textContent = `오류: ${
                error.message || "알림 구독 중 오류가 발생했습니다."
              }`;
              pushStatus.className = "text-sm text-red-600 mt-1";
            }
          });
        }

        if (unsubscribeButton) {
          unsubscribeButton.addEventListener("click", async function () {
            try {
              await unsubscribeFromPushNotifications();
              updatePushButtons(false);
              pushStatus.textContent = "알림 구독이 취소되었습니다.";
              pushStatus.className = "text-sm text-gray-600 mt-1";
            } catch (error) {
              console.error("푸시 알림 구독 취소 오류:", error);
              pushStatus.textContent = `오류: ${
                error.message || "알림 구독 취소 중 오류가 발생했습니다."
              }`;
              pushStatus.className = "text-sm text-red-600 mt-1";
            }
          });
        }
      }

      // 푸시 알림 구독 상태 확인
      async function checkPushSubscription() {
        try {
          if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
            const pushStatus = document.getElementById("push-status");
            if (pushStatus) {
              pushStatus.textContent =
                "이 브라우저는 푸시 알림을 지원하지 않습니다.";
            }
            const subscribeButton = document.getElementById(
              "push-subscribe-button"
            );
            if (subscribeButton) {
              subscribeButton.disabled = true;
            }
            return;
          }

          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();

          if (subscription) {
            pushSubscription = subscription;
            updatePushButtons(true);
          } else {
            updatePushButtons(false);
          }
        } catch (error) {
          console.error("푸시 구독 상태 확인 오류:", error);
        }
      }

      // 푸시 알림 구독 버튼 업데이트
      function updatePushButtons(isSubscribed) {
        const subscribeButton = document.getElementById(
          "push-subscribe-button"
        );
        const unsubscribeButton = document.getElementById(
          "push-unsubscribe-button"
        );

        if (isSubscribed) {
          subscribeButton.classList.add("hidden");
          unsubscribeButton.classList.remove("hidden");
        } else {
          subscribeButton.classList.remove("hidden");
          unsubscribeButton.classList.add("hidden");
        }
      }

      // 푸시 알림 구독
      async function subscribeToPushNotifications() {
        try {
          if (!isLoggedIn) {
            throw new Error("로그인이 필요합니다.");
          }

          if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
            throw new Error("이 브라우저는 푸시 알림을 지원하지 않습니다.");
          }

          // VAPID 공개 키 가져오기
          const response = await fetch(`${API_BASE_URL}/push/vapidPublicKey`);
          const data = await response.json();
          const vapidPublicKey = data.vapidPublicKey;

          // 서비스 워커 등록 확인
          const registration = await navigator.serviceWorker.ready;

          // 이미 구독 중인지 확인
          let subscription = await registration.pushManager.getSubscription();

          if (subscription) {
            // 이미 구독 중이면 기존 구독 반환
            pushSubscription = subscription;
            return subscription;
          }

          // 구독 옵션 설정
          const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);

          // 새 구독 생성
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: applicationServerKey,
          });

          // 서버에 구독 정보 전송
          const token = localStorage.getItem("token");

          const subscribeResponse = await fetch(
            `${API_BASE_URL}/push/subscribe`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(subscription),
            }
          );

          if (!subscribeResponse.ok) {
            const errorData = await subscribeResponse.json();
            throw new Error(
              errorData.message || "구독 처리 중 오류가 발생했습니다."
            );
          }

          pushSubscription = subscription;
          return subscription;
        } catch (error) {
          console.error("푸시 알림 구독 오류:", error);
          throw error;
        }
      }

      // 푸시 알림 구독 취소
      async function unsubscribeFromPushNotifications() {
        try {
          if (!isLoggedIn) {
            throw new Error("로그인이 필요합니다.");
          }

          if (!pushSubscription) {
            const registration = await navigator.serviceWorker.ready;
            pushSubscription = await registration.pushManager.getSubscription();

            if (!pushSubscription) {
              throw new Error("구독 정보를 찾을 수 없습니다.");
            }
          }

          // 서버에 구독 취소 요청
          const token = localStorage.getItem("token");

          const unsubscribeResponse = await fetch(
            `${API_BASE_URL}/push/unsubscribe`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                endpoint: pushSubscription.endpoint,
              }),
            }
          );

          if (!unsubscribeResponse.ok) {
            const errorData = await unsubscribeResponse.json();
            throw new Error(
              errorData.message || "구독 취소 중 오류가 발생했습니다."
            );
          }

          // 브라우저에서 구독 취소
          await pushSubscription.unsubscribe();
          pushSubscription = null;

          return true;
        } catch (error) {
          console.error("푸시 알림 구독 취소 오류:", error);
          throw error;
        }
      }

      // Base64 URL을 Uint8Array로 변환 (VAPID 키 처리용)
      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      // 로그인 상태 확인 및 UI 업데이트
      function checkLoginStatus() {
        const token = localStorage.getItem("token");
        const refreshToken = localStorage.getItem("refreshToken");
        const userStr = localStorage.getItem("user");

        console.log("로그인 상태 확인:", {
          token: token ? "존재함" : "없음",
          refreshToken: refreshToken ? "존재함" : "없음",
          userStr: userStr ? "존재함" : "없음",
        });

        if (token && userStr) {
          try {
            // 사용자 정보 파싱
            currentUser = JSON.parse(userStr);
            isLoggedIn = true;

            // 서버에서 최신 사용자 정보 가져오기
            fetch(`${API_BASE_URL}/users/me`, {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                console.log("사용자 정보 응답:", response.status);
                if (!response.ok) {
                  if (response.status === 401 && refreshToken) {
                    // 액세스 토큰이 만료되었고 리프레시 토큰이 있는 경우
                    return refreshAccessToken(refreshToken);
                  }
                  throw new Error("사용자 정보를 가져오는데 실패했습니다.");
                }
                return response.json();
              })
              .then((userData) => {
                console.log("받은 사용자 데이터:", userData);
                // 서버에서 받은 최신 정보로 업데이트
                currentUser = userData;
                localStorage.setItem("user", JSON.stringify(currentUser));

                // UI 업데이트
                updateAccountUI();
              })
              .catch((error) => {
                console.error("사용자 정보 조회 오류:", error);
                // 오류 발생 시 로그인 페이지로 리다이렉트
                window.location.href = "login.html";
              });
          } catch (error) {
            console.error("사용자 정보 파싱 오류:", error);
            // 오류 발생 시 로그인 페이지로 리다이렉트
            window.location.href = "login.html";
          }
        } else {
          console.log("로그인되지 않은 상태, 로그인 페이지로 리다이렉트");
          // 로그인되지 않은 경우 로그인 페이지로 리다이렉트
          window.location.href = "login.html";
        }
      }

      // 액세스 토큰 갱신 함수
      async function refreshAccessToken(refreshToken) {
        try {
          const response = await fetch(`${API_BASE_URL}/users/refresh-token`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ refreshToken }),
          });

          if (!response.ok) {
            throw new Error("토큰 갱신에 실패했습니다.");
          }

          const data = await response.json();
          localStorage.setItem("token", data.accessToken);
          return data;
        } catch (error) {
          console.error("토큰 갱신 오류:", error);
          throw error;
        }
      }

      // 로그아웃 처리
      function logout() {
        // 로컬 스토리지에서 토큰 및 사용자 정보 제거
        localStorage.removeItem("token");
        localStorage.removeItem("refreshToken");
        localStorage.removeItem("user");
        localStorage.removeItem("rememberMe");

        // 로그인 페이지로 리다이렉트
        window.location.href = "login.html";
      }

      // 계정 정보 UI 업데이트
      function updateAccountUI() {
        if (!currentUser) return;

        // 사용자 이름 및 학교 정보 업데이트
        const nameElement = document.getElementById("user-name");
        const schoolInfoElement = document.getElementById("user-school-info");

        if (nameElement) {
          nameElement.textContent = currentUser.name || "사용자";
        }

        if (schoolInfoElement) {
          let schoolText = currentUser.school || "";
          let gradeText = "";
          let classText = "";

          // 학년 정보 변환 (grade1 -> 1학년)
          if (currentUser.grade) {
            const gradeMatch = currentUser.grade.match(/grade(\d+)/);
            if (gradeMatch) {
              gradeText = gradeMatch[1] + "학년";
            }
          }

          // 반 정보 변환 (class2 -> 2반)
          if (currentUser.class) {
            const classMatch = currentUser.class.match(/class(\d+)/);
            if (classMatch) {
              classText = classMatch[1] + "반";
            }
          }

          schoolInfoElement.textContent =
            `${schoolText} ${gradeText} ${classText}`.trim();
        }

        // 이메일 필드 업데이트
        const emailInput = document.getElementById("email");
        if (emailInput && currentUser.email) {
          emailInput.value = currentUser.email;
        }

        // 학교 정보 폼 업데이트
        const schoolSelect = document.getElementById("school");
        const gradeSelect = document.getElementById("grade");
        const classSelect = document.getElementById("class");

        if (schoolSelect && currentUser.school) {
          schoolSelect.value = currentUser.school;
        }
        if (gradeSelect && currentUser.grade) {
          gradeSelect.value = currentUser.grade;
        }
        if (classSelect && currentUser.class) {
          classSelect.value = currentUser.class;
        }

        // 주간 요약 체크박스 업데이트
        const weeklySummaryCheckbox = document.getElementById(
          "weekly-summary-checkbox"
        );
        if (weeklySummaryCheckbox && currentUser.weeklySummary !== undefined) {
          weeklySummaryCheckbox.checked = currentUser.weeklySummary;
          localStorage.setItem("weeklySummary", currentUser.weeklySummary);
        }

        // 로그인/로그아웃 버튼 업데이트
        updateLoginLogoutButtons();
      }

      // 로그인/로그아웃 버튼 업데이트
      function updateLoginLogoutButtons() {
        // 데스크톱 네비게이션 업데이트
        const desktopNav = document.querySelector(
          "header.hidden.md\\:block nav ul"
        );
        if (desktopNav) {
          const loginLi = desktopNav.querySelector("li:last-child");
          if (loginLi) {
            loginLi.innerHTML = `
              <a href="#" id="logout-btn" class="text-gray-600 hover:text-primary">로그아웃</a>
            `;

            // 로그아웃 버튼 이벤트 추가
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
              logoutBtn.addEventListener("click", function (e) {
                e.preventDefault();
                logout();
              });
            }
          }
        }

        // 모바일 네비게이션 업데이트
        const mobileNav = document.querySelector("nav.md\\:hidden .flex");
        if (mobileNav) {
          const loginLink = mobileNav.querySelector("a:last-child");
          if (loginLink) {
            loginLink.href = "#";

            const icon = loginLink.querySelector("i");
            if (icon) {
              icon.classList.remove("fa-sign-in-alt");
              icon.classList.add("fa-sign-out-alt");
            }

            const span = loginLink.querySelector("span");
            if (span) {
              span.textContent = "로그아웃";
            }

            // 로그아웃 이벤트 추가
            loginLink.addEventListener("click", function (e) {
              e.preventDefault();
              logout();
            });
          }
        }
      }

      // 계정 정보 업데이트 API 호출
      async function updateAccountInfo(email, password) {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("로그인이 필요합니다.");
          }

          const data = {};
          if (email) data.email = email;
          if (password) data.password = password;

          const response = await fetch(`${API_BASE_URL}/users/account`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const responseData = await response.json();
            throw new Error(
              responseData.message || "계정 정보 업데이트에 실패했습니다."
            );
          }

          // 이메일이 변경된 경우 사용자 정보 업데이트
          if (email && currentUser) {
            currentUser.email = email;
            localStorage.setItem("user", JSON.stringify(currentUser));
          }

          return await response.json();
        } catch (error) {
          console.error("계정 정보 업데이트 API 오류:", error);
          throw error;
        }
      }

      // 계정 삭제 기능 구현
      async function deleteAccount() {
        try {
          // 사용자 확인
          const confirmed = confirm(
            "정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
          );
          if (!confirmed) return;

          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("로그인이 필요합니다.");
          }

          const response = await fetch(`${API_BASE_URL}/users/account`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            const responseData = await response.json();
            throw new Error(
              responseData.message || "계정 삭제에 실패했습니다."
            );
          }

          // 로컬 스토리지 정보 삭제
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          localStorage.removeItem("rememberMe");

          alert("계정이 성공적으로 삭제되었습니다.");

          // 로그인 페이지로 리다이렉트
          window.location.href = "login.html";
        } catch (error) {
          console.error("계정 삭제 API 오류:", error);
          alert(`계정 삭제 중 오류가 발생했습니다: ${error.message}`);
        }
      }

      // 학교 목록 가져오기
      async function fetchSchools() {
        try {
          const response = await fetch(`${API_BASE_URL}/schools`);
          if (!response.ok) {
            throw new Error("학교 목록을 가져오는데 실패했습니다.");
          }
          const schools = await response.json();

          const schoolSelect = document.getElementById("school");
          if (schoolSelect) {
            // 기존 옵션 유지 (첫 번째 옵션)
            const firstOption = schoolSelect.options[0];
            schoolSelect.innerHTML = "";
            schoolSelect.appendChild(firstOption);

            // 학교 목록 추가
            schools.forEach((school) => {
              const option = document.createElement("option");
              option.value = school.name;
              option.textContent = school.name;
              schoolSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error("학교 목록 조회 오류:", error);
        }
      }

      // 학교 정보 업데이트
      async function updateSchoolInfo(school, grade, className) {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("로그인이 필요합니다.");
          }

          const response = await fetch(`${API_BASE_URL}/users/account`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              school,
              grade,
              class: className,
            }),
          });

          if (!response.ok) {
            const responseData = await response.json();
            throw new Error(
              responseData.message || "학교 정보 업데이트에 실패했습니다."
            );
          }

          const responseData = await response.json();

          // 서버에서 최신 사용자 정보 다시 가져오기
          const userResponse = await fetch(`${API_BASE_URL}/users/me`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!userResponse.ok) {
            throw new Error("사용자 정보를 가져오는데 실패했습니다.");
          }

          const userData = await userResponse.json();
          localStorage.setItem("user", JSON.stringify(userData));

          // UI 업데이트
          updateAccountUI();
        } catch (error) {
          console.error("학교 정보 업데이트 오류:", error);
          throw error;
        }
      }
    </script>
  </body>
</html>
